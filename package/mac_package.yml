macos-arm64:
    image: mac-arm64
    cpus: 4
    memory: 12G
    steps:
    - name: Copy Files
      copy:
        from: ./
        to: vm:~/
        exclude:
            - .git
            - .github
            - docs

    - name: Install Rust targets
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
        rustup target add x86_64-apple-darwin
        rustup target add aarch64-apple-darwin

    - name: Build aarch64
      run: cargo build --release --target aarch64-apple-darwin

    - name: Build x86_64
      run: cargo build --release --target x86_64-apple-darwin

    - name: Create fat binary
      run: |
        lipo -create \
          target/aarch64-apple-darwin/release/virtci \
          target/x86_64-apple-darwin/release/virtci \
          -output virtci
        chmod +x virtci

    - name: Package
      run: tar czf virtci-macos.tar.gz virtci

    - name: Copy Files
      copy:
        from: vm:~/virtci-macos.tar.gz
        to: ./
